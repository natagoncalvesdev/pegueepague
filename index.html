<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pegue e Pague - Sistema de Estoque</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%9B%92%3C/text%3E%3C/svg%3E">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      padding: 20px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn-toggle {
      background: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn-toggle.active {
      background: #28a745;
      color: white;
    }

    .login-form {
      max-width: 400px;
      margin: 0 auto;
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
    }

    .login-form h3 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .error-message {
      background: #dc3545;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      display: none;
    }

    .view {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .view.active {
      display: block;
    }

    .produto {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 12px;
      transition: all 0.3s;
      border-left: 4px solid #28a745;
    }

    .produto:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .produto-sem-estoque {
      background: #e9ecef !important;
      opacity: 0.7;
      border-left: 4px solid #6c757d !important;
    }

    .produto-sem-estoque .produto-nome {
      color: #6c757d !important;
      text-decoration: line-through;
    }

    .produto-sem-estoque .produto-detalhes {
      color: #adb5bd !important;
    }

    .produto-sem-estoque .produto-preco {
      color: #6c757d !important;
    }

    .produto-sem-estoque button {
      opacity: 0.5;
      cursor: not-allowed !important;
    }

    .produto-no-carrinho {
      background: #d4edda !important;
      border-left: 4px solid #28a745 !important;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
    }

    .produto-no-carrinho .produto-nome::before {
      content: "‚úì ";
      color: #28a745;
      font-weight: bold;
    }

    .cart-badge {
      background: #28a745;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: bold;
      margin-left: 8px;
    }

    .produto-info {
      flex: 1;
    }

    .produto-nome {
      font-weight: bold;
      font-size: 1.1em;
      color: #333;
    }

    .produto-detalhes {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    .produto-preco {
      font-size: 1.2em;
      font-weight: bold;
      color: #28a745;
      margin-right: 15px;
    }

    .produto-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .quantidade-input {
      width: 70px;
      text-align: center;
      padding: 8px;
      border: 2px solid #28a745;
      border-radius: 8px;
      font-weight: bold;
    }

    .total-container {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
    }

    .total {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .total-sub {
      font-size: 1em;
      opacity: 0.9;
    }

    #pixArea {
      text-align: center;
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
    }

    #pixCode {
      word-wrap: break-word;
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .admin-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #28a745;
    }

    .cart-container {
      margin-top: 20px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 5px 0;
    }

    .badge {
      background: #dc3545;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: bold;
    }

    .badge-success {
      background: #28a745;
    }

    /* Notifica√ß√µes de sugest√µes */
    .notif-btn {
      position: relative;
    }
    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #dc3545;
      color: #fff;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 12px;
      font-weight: bold;
      display: none;
    }

    @media (max-width: 600px) {
      .produto {
        flex-direction: column;
        align-items: flex-start;
        padding: 18px;
        margin: 14px 0;
      }

      .produto-actions {
        width: 100%;
        margin-top: 12px;
        gap: 10px;
      }

      .produto-preco {
        margin-right: 0;
        margin-bottom: 12px;
      }

      .btn {
        padding: 10px 18px;
      }

      .quantidade-input {
        padding: 10px;
      }

      .form-group {
        margin-bottom: 18px;
      }

      .cart-item {
        padding: 12px;
        margin: 8px 0;
      }

      /* Espa√ßamento entre bot√µes de a√ß√£o no mobile */
      .action-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .action-buttons .btn {
        margin-left: 0 !important;
      }

      /* Otimiza√ß√µes da √Årea Admin para Mobile */
      #viewAdmin .produto {
        align-items: stretch; /* Alinha itens para preencher a largura */
      }
      #viewAdmin .produto-info {
        margin-bottom: 15px; /* Espa√ßo entre info e a√ß√µes */
      }
      #viewAdmin .produto-actions {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }
      #viewAdmin .produto-actions .quantidade-input {
        width: 100%;
      }
      #viewAdmin .produto-actions .btn {
        width: 100%;
      }
      .admin-header-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        margin-top: 15px;
      }
      .admin-header-actions .btn {
        margin-left: 0 !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üõí Pegue e Pague</h1>
    <p>Sistema de Estoque Inteligente</p>
  </div>

  <div class="view-toggle">
    <button class="btn-toggle active" onclick="showView('cliente')">üë§ √Årea do Cliente</button>
    <button class="btn-toggle" onclick="mostrarLogin()">‚öôÔ∏è Administra√ß√£o</button>
  </div>

  <!-- VIEW CLIENTE -->
  <div id="viewCliente" class="view active">
    <div class="form-group" style="margin-bottom: 20px;">
      <input type="text" id="buscaCliente" onkeyup="renderProdutos()" placeholder="üîé Buscar produto..." autocomplete="off">
    </div>
    <div id="produtosList"></div>
    
    <div class="total-container">
      <div class="total">Total: R$ <span id="total">0,00</span></div>
      <div class="total-sub">Produtos no carrinho: <span id="totalItens">0</span></div>
    </div>

    <div class="action-buttons" style="text-align:center;">
      <button class="btn btn-success" onclick="gerarPix()" style="padding: 15px 30px; font-size: 18px;">
        üí≥ Gerar QR Code PIX
      </button>
      <button class="btn btn-secondary" onclick="limparCarrinho()" style="padding: 15px 30px; font-size: 18px; margin-left: 10px;">
        üóëÔ∏è Limpar Carrinho
      </button>
    </div>

    <div id="pixArea" style="display:none;">
      <div id="qrcode"></div>
      <div id="pixCode"></div>
      <button class="btn btn-success" onclick="copiarPix()" style="margin-top: 15px;">
        üìã Copiar C√≥digo PIX
      </button>
    </div>

    <div id="carrinho" class="cart-container" style="display:none;">
      <h3>Seu Carrinho:</h3>
      <div id="cartItems"></div>
    </div>

    <!-- SUGEST√ïES - CLIENTE -->
    <div class="admin-form" style="margin-top:20px;">
      <h3>üí¨ Enviar Sugest√£o</h3>
      <div class="form-group">
        <label>Seu Nome</label>
        <input type="text" id="sugestaoNome" placeholder="Digite seu nome" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Sugest√£o</label>
        <input type="text" id="sugestaoTexto" placeholder="Digite sua sugest√£o" autocomplete="off">
      </div>
      <button class="btn btn-success" onclick="enviarSugestao()">üì® Enviar Sugest√£o</button>
    </div>
  </div>

  <!-- VIEW LOGIN -->
  <div id="viewLogin" class="view">
    <div class="login-form">
      <h3>üîê Acesso Administrativo</h3>
      <div class="error-message" id="loginError">Usu√°rio ou senha incorretos!</div>
      <div class="form-group">
        <label>Usu√°rio</label>
        <input type="text" id="loginUsuario" placeholder="Digite o usu√°rio" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="loginSenha" placeholder="Digite a senha">
      </div>
      <button class="btn btn-success" onclick="fazerLogin()" style="width: 100%; padding: 12px;">
        üö™ Entrar
      </button>
      <button class="btn btn-secondary" onclick="voltarParaCliente()" style="width: 100%; margin-top: 10px; padding: 12px;">
        ‚¨ÖÔ∏è Voltar
      </button>
    </div>
  </div>

  <!-- VIEW ADMIN -->
  <div id="viewAdmin" class="view">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>‚öôÔ∏è Painel Administrativo</h2>
      <button class="btn btn-secondary" onclick="logout()">üö™ Sair</button>
    </div>

    <!-- Navega√ß√£o da √Årea Admin -->
    <div class="view-toggle" id="adminNav" style="margin-bottom: 20px;">
      <button class="btn-toggle active" onclick="showAdminSection('produtos')">üì¶ Produtos</button>
      <button class="btn-toggle notif-btn" onclick="showAdminSection('sugestoes')">
        üí¨ Sugest√µes <span id="sugestoesBadge" class="notif-count">0</span>
      </button>
      <button class="btn-toggle" onclick="showAdminSection('historico')">üßæ Hist√≥rico</button>
    </div>

    <!-- Se√ß√£o de Produtos -->
    <div id="adminSectionProdutos" class="admin-section active">
      <div class="admin-form">
        <h3>‚ûï Adicionar Novo Produto</h3>
        <div class="form-group">
          <label>Nome do Produto</label>
          <input type="text" id="produtoNome" placeholder="Ex: Coca-Cola 350ml">
        </div>
        <div class="form-group">
          <label>Pre√ßo (R$)</label>
          <input type="number" id="produtoPreco" step="0.01" placeholder="Ex: 5.50" min="0">
        </div>
        <div class="form-group">
          <label>Quantidade em Estoque</label>
          <input type="number" id="produtoQuantidade" placeholder="Ex: 50" min="0">
        </div>
        <button class="btn btn-success" onclick="adicionarProduto()">‚ûï Adicionar Produto</button>
      </div>
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3>üì¶ Lista de Produtos</h3>
          <input type="text" id="buscaAdmin" onkeyup="renderAdminProdutos()" placeholder="üîé Buscar..." style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; width: 40%;">
        </div>
        <div id="adminProdutosList"></div>
      </div>
    </div>

    <!-- Se√ß√£o de Sugest√µes -->
    <div id="adminSectionSugestoes" class="admin-section" style="display: none;">
      <div class="admin-form">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h3>üí¨ Sugest√µes Recebidas</h3>
          <div class="admin-header-actions">
            <button class="btn btn-warning" onclick="marcarTodasComoLidas()">‚úîÔ∏è Marcar todas como lidas</button>
            <button class="btn btn-danger" onclick="apagarSugestoesLidas()" style="margin-left:8px;">üóëÔ∏è Apagar lidas</button>
          </div>
        </div>
        <div id="sugestoesList"></div>
      </div>
    </div>

    <!-- Se√ß√£o de Hist√≥rico -->
    <div id="adminSectionHistorico" class="admin-section" style="display: none;">
      <div class="admin-form">
        <h3>üßæ Hist√≥rico de Compras</h3>
        <div id="historicoList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Configura√ß√£o Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAguTud4KXk9CV6KUR77Ru8xeFK4ml-NGU",
  authDomain: "pegueepague-d2d21.firebaseapp.com",
  databaseURL: "https://pegueepague-d2d21-default-rtdb.firebaseio.com",
  projectId: "pegueepague-d2d21",
  storageBucket: "pegueepague-d2d21.firebasestorage.app",
  messagingSenderId: "770178985783",
  appId: "1:770178985783:web:8a3591340f01578d50b4b2"
};

// Inicializar Firebase
let db = null;
let isAdminLogged = false;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('Firebase conectado com sucesso!');
} catch (error) {
  console.log('Firebase n√£o configurado ainda. Usando localStorage como fallback.');
}

// Sistema de Estoque
let estoque = [];
let carrinho = [];
let nextId = 4;

// Sistema de Sugest√µes
let sugestoes = [];

// Sistema de Compras (Hist√≥rico)
let compras = [];

// Salvar estoque (Firebase ou localStorage)
function salvarEstoque() {
  if (db) {
    // Salvar no Firebase
    db.ref('estoque/produtos').set(estoque);
    db.ref('estoque/nextId').set(nextId);
  } else {
    // Fallback para localStorage
    localStorage.setItem('estoque', JSON.stringify(estoque));
    localStorage.setItem('nextId', nextId.toString());
  }
}

// Salvar sugest√µes (Firebase ou localStorage)
function salvarSugestoes() {
  if (db) {
    db.ref('sugestoes').set(sugestoes);
  } else {
    localStorage.setItem('sugestoes', JSON.stringify(sugestoes));
  }
}

// Carregar sugest√µes (Firebase ou localStorage)
async function carregarSugestoes() {
  if (db) {
    const snapshot = await db.ref('sugestoes').once('value');
    sugestoes = snapshot.val() || [];
  } else {
    sugestoes = JSON.parse(localStorage.getItem('sugestoes')) || [];
  }
  atualizarBadgeSugestoes();
}

// Enviar sugest√£o (cliente)
function enviarSugestao() {
  const nome = document.getElementById('sugestaoNome').value.trim();
  const texto = document.getElementById('sugestaoTexto').value.trim();
  if (!nome || !texto) {
    alert('Informe seu nome e sua sugest√£o.');
    return;
  }
  const nova = {
    id: Date.now(),
    nome: nome,
    texto: texto,
    lida: false,
    criadoEm: new Date().toISOString()
  };
  adicionarSugestao(nova);
  document.getElementById('sugestaoNome').value = '';
  document.getElementById('sugestaoTexto').value = '';
  alert('Sugest√£o enviada! Obrigado.');
}

// Atualiza badge de sugest√µes n√£o lidas (apenas admin v√™)
function atualizarBadgeSugestoes() {
  const naoLidas = sugestoes.filter(s => !s.lida).length;
  const badge = document.getElementById('sugestoesBadge');
  if (!badge) return;
  if (naoLidas > 0) {
    badge.textContent = naoLidas.toString();
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

// Renderiza lista de sugest√µes no admin
function renderSugestoesAdmin() {
  const list = document.getElementById('sugestoesList');
  if (!list) return;
  list.innerHTML = '';
  if (sugestoes.length === 0) {
    list.innerHTML = '<p style="text-align:center; padding:10px;">Nenhuma sugest√£o recebida.</p>';
    return;
  }
  sugestoes.forEach(s => {
    const div = document.createElement('div');
    div.className = 'produto';
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <div class="produto-info">
        <div class="produto-nome">${s.nome} ${!s.lida ? '<span class="badge">novo</span>' : ''}</div>
        <div class="produto-detalhes">${new Date(s.criadoEm).toLocaleString()}</div>
        <div style="margin-top:8px; color:#333;">${s.texto}</div>
      </div>
      <div class="produto-actions">
        ${s.lida ? '' : `<button class="btn btn-success" onclick="marcarSugestaoComoLida(${s.id})">‚úîÔ∏è Marcar como lida</button>`}
        ${s.lida ? `<button class=\"btn btn-danger\" onclick=\"apagarSugestao(${s.id})\">üóëÔ∏è Apagar</button>` : ''}
      </div>
    `;
    list.appendChild(div);
  });
}

function marcarSugestaoComoLida(id) {
  const s = sugestoes.find(x => x.id === id);
  if (!s) return;
  s.lida = true;
  salvarSugestoes();
  atualizarBadgeSugestoes();
  renderSugestoesAdmin();
}

function marcarTodasComoLidas() {
  let mudou = false;
  sugestoes.forEach(s => { if (!s.lida) { s.lida = true; mudou = true; } });
  if (mudou) {
    salvarSugestoes();
    atualizarBadgeSugestoes();
    renderSugestoesAdmin();
  }
}

// Adicionar sugest√£o de forma at√¥mica (evita sobrescrever leituras anteriores)
function adicionarSugestao(nova) {
  if (db) {
    firebase.database().ref('sugestoes').transaction(curr => {
      const listaAtual = Array.isArray(curr) ? curr : [];
      return [nova, ...listaAtual];
    }, undefined, false).then(() => {
      // Recarrega do servidor para manter flags 'lida' corretas
      carregarSugestoes();
      atualizarBadgeSugestoes();
    }).catch(() => {
      // Fallback: se transa√ß√£o falhar por algum motivo, usa leitura+grava√ß√£o simples
      db.ref('sugestoes').once('value').then(snap => {
        const lista = Array.isArray(snap.val()) ? snap.val() : [];
        const novaLista = [nova, ...lista];
        return db.ref('sugestoes').set(novaLista);
      }).then(() => {
        carregarSugestoes();
        atualizarBadgeSugestoes();
      });
    });
  } else {
    // localStorage: l√™ o estado mais recente e preserva 'lida'
    const lista = JSON.parse(localStorage.getItem('sugestoes')) || [];
    const novaLista = [nova, ...lista];
    localStorage.setItem('sugestoes', JSON.stringify(novaLista));
    sugestoes = novaLista;
    atualizarBadgeSugestoes();
  }
}

function apagarSugestao(id) {
  sugestoes = sugestoes.filter(s => s.id !== id);
  salvarSugestoes();
  atualizarBadgeSugestoes();
  renderSugestoesAdmin();
}

function apagarSugestoesLidas() {
  const antes = sugestoes.length;
  sugestoes = sugestoes.filter(s => !s.lida);
  if (sugestoes.length !== antes) {
    salvarSugestoes();
    atualizarBadgeSugestoes();
    renderSugestoesAdmin();
  }
}

// Carregar estoque (Firebase ou localStorage)
async function carregarEstoque() {
  if (db) {
    // Carregar do Firebase
    const snapshot = await db.ref('estoque/produtos').once('value');
    estoque = snapshot.val() || [];
    
    const idSnapshot = await db.ref('estoque/nextId').once('value');
    nextId = idSnapshot.val() || 4;
    
    // Se Firebase estiver vazio, inicializar com dados padr√£o
    if (estoque.length === 0) {
      estoque = [
        { id: 1, nome: 'Energ√©tico Monster', preco: 8.99, quantidade: 20 },
        { id: 2, nome: 'Pa√ßoca', preco: 0.50, quantidade: 100 },
        { id: 3, nome: 'Halls', preco: 1.99, quantidade: 50 }
      ];
      salvarEstoque();
    }
    
    renderProdutos();
  } else {
    // Fallback para localStorage
    estoque = JSON.parse(localStorage.getItem('estoque')) || [
      { id: 1, nome: 'Energ√©tico Monster', preco: 8.99, quantidade: 20 },
      { id: 2, nome: 'Pa√ßoca', preco: 0.50, quantidade: 100 },
      { id: 3, nome: 'Halls', preco: 1.99, quantidade: 50 }
    ];
    
    const savedId = localStorage.getItem('nextId');
    if (savedId) {
      nextId = parseInt(savedId);
    } else {
      nextId = Math.max(...estoque.map(p => p.id)) + 1;
    }
    
    renderProdutos();
  }
}

// Navega√ß√£o de views
function showView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
  
  if (view === 'cliente') {
    document.getElementById('viewCliente').classList.add('active');
    document.querySelectorAll('.btn-toggle')[0].classList.add('active');
    renderProdutos();
  } else if (view === 'admin') {
    document.getElementById('viewAdmin').classList.add('active');
    document.querySelectorAll('.btn-toggle')[1].classList.add('active');
    renderAdminProdutos();
  }
}

// Mostrar tela de login (ou admin direto se j√° autenticado)
function mostrarLogin() {
  if (isAdminLogged) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('viewAdmin').classList.add('active');
    document.querySelectorAll('.btn-toggle')[1].classList.add('active');
    renderAdminProdutos();
    return;
  }
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
  document.getElementById('viewLogin').classList.add('active');
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginUsuario').value = '';
  document.getElementById('loginSenha').value = '';
}

// Fazer login
function fazerLogin() {
  const usuario = document.getElementById('loginUsuario').value.trim();
  const senha = document.getElementById('loginSenha').value;

  // Credenciais corretas
  if (usuario === 'supervisor' && senha === 'senhadosupervisor') {
    // Login bem-sucedido, mostrar √°rea admin
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('viewAdmin').classList.add('active');
    document.querySelectorAll('.btn-toggle')[1].classList.add('active');
    showAdminSection('produtos'); // Mostra a se√ß√£o de produtos por padr√£o
    atualizarBadgeSugestoes();
    isAdminLogged = true;
    try { localStorage.setItem('isAdminLogged', '1'); } catch(e) {}
  } else {
    // Erro de login
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('loginSenha').value = '';
  }
}

// Voltar para √°rea do cliente
function voltarParaCliente() {
  showView('cliente');
}

// Logout
function logout() {
  isAdminLogged = false;
  try { localStorage.removeItem('isAdminLogged'); } catch(e) {}
  mostrarLogin();
}

// Mostrar se√ß√£o espec√≠fica da √°rea admin
function showAdminSection(sectionName) {
  // Esconde todas as se√ß√µes
  document.querySelectorAll('.admin-section').forEach(sec => sec.style.display = 'none');
  // Remove a classe 'active' de todos os bot√µes de navega√ß√£o admin
  document.querySelectorAll('#adminNav .btn-toggle').forEach(btn => btn.classList.remove('active'));

  // Mostra a se√ß√£o correta e ativa o bot√£o
  document.getElementById(`adminSection${capitalize(sectionName)}`).style.display = 'block';
  document.querySelector(`#adminNav .btn-toggle[onclick="showAdminSection('${sectionName}')"]`).classList.add('active');

  // Renderiza o conte√∫do da se√ß√£o ao ser exibida
  if (sectionName === 'produtos') renderAdminProdutos();
  if (sectionName === 'sugestoes') renderSugestoesAdmin();
  if (sectionName === 'historico') renderHistoricoCompras();
}
const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);

// Renderizar produtos na view cliente
function renderProdutos() {
  const container = document.getElementById('produtosList');
  const termoBusca = document.getElementById('buscaCliente')?.value.toLowerCase().trim() || '';
  container.innerHTML = '';

  const palavrasBusca = termoBusca.split(' ').filter(Boolean); // Separa o termo em palavras

  const estoqueFiltrado = estoque.filter(p => {
    const nomeProduto = p.nome.toLowerCase();
    // Verifica se TODAS as palavras da busca est√£o contidas no nome do produto
    return palavrasBusca.every(palavra => nomeProduto.includes(palavra));
  });

  if (estoque.length === 0) { // Mensagem se o estoque original est√° vazio
    container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhum produto dispon√≠vel no momento.</p>';
    return;
  }

  if (estoqueFiltrado.length === 0) { // Mensagem se a busca n√£o retorna resultados
    container.innerHTML = `<p style="text-align:center; padding:20px;">Nenhum produto encontrado para "<strong>${termoBusca}</strong>".</p>`;
    return;
  }

  // Separar produtos com estoque e sem estoque
  const produtosComEstoque = estoqueFiltrado.filter(p => p.quantidade > 0)
    .sort((a, b) => a.nome.localeCompare(b.nome));
  const produtosSemEstoque = estoqueFiltrado.filter(p => p.quantidade <= 0)
    .sort((a, b) => a.nome.localeCompare(b.nome));

  // Renderizar produtos COM estoque primeiro
  produtosComEstoque.forEach(produto => {
    const itemCarrinho = carrinho.find(item => item.id === produto.id);
    const quantidadeCarrinho = itemCarrinho ? itemCarrinho.quantidade : 0;
    const noCarrinho = quantidadeCarrinho > 0;
    
    const div = document.createElement('div');
    div.className = noCarrinho ? 'produto produto-no-carrinho' : 'produto';
    div.innerHTML = `
      <div class="produto-info">
        <div class="produto-nome">
          ${produto.nome}
          ${noCarrinho ? `<span class="cart-badge">${quantidadeCarrinho}x</span>` : ''}
        </div>
        <div class="produto-detalhes">Estoque: ${produto.quantidade} unidades</div>
      </div>
      <div class="produto-preco">R$ ${produto.preco.toFixed(2)}</div>
      <div class="produto-actions">
        <button class="btn btn-success" onclick="adicionarAoCarrinho(${produto.id})">‚ûï Adicionar</button>
      </div>
    `;
    container.appendChild(div);
  });

  // Renderizar produtos SEM estoque no final (cinza)
  produtosSemEstoque.forEach(produto => {
    const div = document.createElement('div');
    div.className = 'produto produto-sem-estoque';
    div.innerHTML = `
      <div class="produto-info">
        <div class="produto-nome">${produto.nome}</div>
        <div class="produto-detalhes">Esgotado</div>
      </div>
      <div class="produto-preco">R$ ${produto.preco.toFixed(2)}</div>
      <div class="produto-actions">
        <button class="btn btn-success" disabled>Indispon√≠vel</button>
      </div>
    `;
    container.appendChild(div);
  });

  // Se n√£o houver produtos dispon√≠veis, mostrar mensagem
  if (produtosComEstoque.length === 0 && produtosSemEstoque.length > 0) {
    const mensagemDiv = document.createElement('div');
    mensagemDiv.style.cssText = 'text-align:center; padding:20px; color:#dc3545; font-weight:bold;';
    mensagemDiv.textContent = '‚ö†Ô∏è Todos os produtos est√£o esgotados!';
    container.insertBefore(mensagemDiv, container.firstChild);
  }
}

// Renderizar produtos na view admin
function renderAdminProdutos() {
  const container = document.getElementById('adminProdutosList');
  const termoBusca = document.getElementById('buscaAdmin')?.value.toLowerCase().trim() || '';
  container.innerHTML = '';

  if (estoque.length === 0) {
    container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhum produto cadastrado.</p>';
    return;
  }

  const palavrasBusca = termoBusca.split(' ').filter(Boolean); // Separa o termo em palavras

  const estoqueFiltrado = estoque.filter(p => {
    const nomeProduto = p.nome.toLowerCase();
    return palavrasBusca.every(palavra => nomeProduto.includes(palavra));
  });
  
  if (estoqueFiltrado.length === 0) {
    container.innerHTML = `<p style="text-align:center; padding:20px;">Nenhum produto encontrado para "<strong>${termoBusca}</strong>".</p>`;
    return;
  }
  const estoqueOrdenado = [...estoqueFiltrado].sort((a, b) => a.nome.localeCompare(b.nome));
  estoqueOrdenado.forEach(produto => {
    const div = document.createElement('div');
    div.className = 'produto';
    div.innerHTML = `
      <div class="produto-info">
        <div class="produto-nome">${produto.nome}</div>
        <div class="produto-detalhes">Pre√ßo: R$ ${produto.preco.toFixed(2)} | Estoque: ${produto.quantidade} unidades</div>
      </div>
      <div class="produto-actions">
        <input type="number" class="quantidade-input" id="qtdEdit_${produto.id}" value="${produto.quantidade}" min="0">
        <input type="number" class="quantidade-input" id="precoEdit_${produto.id}" value="${produto.preco}" step="0.01" min="0">
        <button class="btn btn-warning" onclick="salvarEdicao(${produto.id})">üíæ Salvar</button>
        <button class="btn btn-danger" onclick="removerProduto(${produto.id})">üóëÔ∏è Excluir</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// Adicionar produto ao carrinho
function adicionarAoCarrinho(id) {
  const produto = estoque.find(p => p.id === id);
  if (!produto) return;

  if (produto.quantidade <= 0) {
    alert('Produto sem estoque!');
    return;
  }

  const itemCarrinho = carrinho.find(item => item.id === id);
  
  if (itemCarrinho) {
    if (itemCarrinho.quantidade >= produto.quantidade) {
      alert('Quantidade m√°xima dispon√≠vel atingida!');
      return;
    }
    itemCarrinho.quantidade++;
  } else {
    carrinho.push({ ...produto, quantidade: 1 });
  }

  atualizarCarrinho();
  renderProdutos();
}

// Atualizar visualiza√ß√£o do carrinho
function atualizarCarrinho() {
  let total = 0;
  let totalItens = 0;

  carrinho.forEach(item => {
    total += item.preco * item.quantidade;
    totalItens += item.quantidade;
  });

  document.getElementById('total').textContent = total.toFixed(2);
  document.getElementById('totalItens').textContent = totalItens;

  // Renderizar itens do carrinho
  const cartContainer = document.getElementById('cartItems');
  const carrinhoDiv = document.getElementById('carrinho');
  
  if (carrinho.length > 0) {
    carrinhoDiv.style.display = 'block';
    cartContainer.innerHTML = '';
    
    carrinho.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div>
          <strong>${item.nome}</strong>
          <span class="badge">x${item.quantidade}</span>
        </div>
        <div>
          R$ ${(item.preco * item.quantidade).toFixed(2)}
          <button class="btn btn-danger" onclick="removerDoCarrinho(${item.id})" style="margin-left: 10px; padding: 4px 8px;">‚ùå</button>
        </div>
      `;
      cartContainer.appendChild(div);
    });
  } else {
    carrinhoDiv.style.display = 'none';
  }
}

// Remover do carrinho
function removerDoCarrinho(id) {
  const itemIndex = carrinho.findIndex(item => item.id === id);
  if (itemIndex !== -1) {
    carrinho[itemIndex].quantidade--;
    if (carrinho[itemIndex].quantidade <= 0) {
      carrinho.splice(itemIndex, 1);
    }
  }
  atualizarCarrinho();
  renderProdutos();
}

// Limpar carrinho
function limparCarrinho() {
  carrinho = [];
  atualizarCarrinho();
  renderProdutos();
}

// Adicionar produto (admin)
function adicionarProduto() {
  const nome = document.getElementById('produtoNome').value.trim();
  const preco = parseFloat(document.getElementById('produtoPreco').value);
  const quantidade = parseInt(document.getElementById('produtoQuantidade').value);

  if (!nome || preco < 0 || quantidade < 0) {
    alert('Preencha todos os campos corretamente!');
    return;
  }

  estoque.push({
    id: nextId++,
    nome: nome,
    preco: preco,
    quantidade: quantidade
  });

  salvarEstoque();
  renderAdminProdutos();
  
  // Limpar formul√°rio
  document.getElementById('produtoNome').value = '';
  document.getElementById('produtoPreco').value = '';
  document.getElementById('produtoQuantidade').value = '';
  
  alert('Produto adicionado com sucesso!');
}

// Salvar edi√ß√£o (admin)
function salvarEdicao(id) {
  const produto = estoque.find(p => p.id === id);
  if (!produto) return;

  const novaQuantidade = parseInt(document.getElementById(`qtdEdit_${id}`).value);
  const novoPreco = parseFloat(document.getElementById(`precoEdit_${id}`).value);

  if (novaQuantidade < 0 || novoPreco < 0) {
    alert('Valores inv√°lidos!');
    return;
  }

  produto.quantidade = novaQuantidade;
  produto.preco = novoPreco;

  salvarEstoque();
  renderAdminProdutos();
  alert('Produto atualizado com sucesso!');
}

// Remover produto (admin)
function removerProduto(id) {
  if (!confirm('Tem certeza que deseja excluir este produto?')) return;

  estoque = estoque.filter(p => p.id !== id);
  salvarEstoque();
  renderAdminProdutos();
}

// Gerar PIX
function gerarPix() {
  if (carrinho.length === 0) {
    alert('Adicione produtos ao carrinho primeiro!');
    return;
  }

  const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);

  // Snapshot dos itens do carrinho antes de modifica√ß√µes
  const itensCompra = carrinho.map(item => ({ id: item.id, nome: item.nome, preco: item.preco, quantidade: item.quantidade }));

  // DADOS PIX
  const chave = "09518875995";
  const nome = "Pegue e Pague";
  const cidade = "APUCARANA";
  const valor = total.toFixed(2);

  // ABAIXAR ESTOQUE DOS PRODUTOS COMPRADOS
  carrinho.forEach(itemCarrinho => {
    const produtoEstoque = estoque.find(p => p.id === itemCarrinho.id);
    if (produtoEstoque) {
      produtoEstoque.quantidade -= itemCarrinho.quantidade;
      if (produtoEstoque.quantidade < 0) {
        produtoEstoque.quantidade = 0; // Garantir que n√£o fique negativo
      }
    }
  });

  // SALVAR ESTOQUE ATUALIZADO
  salvarEstoque();
  
  // ATUALIZAR INTERFACE
  renderProdutos();

  // GERA O PAYLOAD PIX
  const pixPayload = gerarPayload(chave, nome, cidade, valor);

  // EXIBE QR CODE
  document.getElementById('qrcode').innerHTML = '';
  document.getElementById('pixArea').style.display = 'block';
  
  new QRCode(document.getElementById('qrcode'), {
    text: pixPayload,
    width: 250,
    height: 250,
    colorDark: '#000000',
    colorLight: '#ffffff'
  });

  // EXIBE O C√ìDIGO COPIA E COLA
  document.getElementById('pixCode').textContent = pixPayload;
  
  // SCROLL SUAVE AT√â O QR CODE
  document.getElementById('pixArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // REGISTRAR COMPRA NO HIST√ìRICO
  const registro = {
    id: Date.now(),
    itens: itensCompra,
    total: parseFloat(valor),
    criadoEm: new Date().toISOString(),
    payloadPix: pixPayload
  };
  adicionarCompraRegistro(registro);

  // LIMPAR CARRINHO AP√ìS GERAR PIX
  setTimeout(() => {
    carrinho = [];
    atualizarCarrinho();
  }, 1000);
}

// Copiar c√≥digo PIX
function copiarPix() {
  const pixCode = document.getElementById('pixCode').textContent;
  navigator.clipboard.writeText(pixCode).then(() => {
    alert('C√≥digo PIX copiado para a √°rea de transfer√™ncia!');
  }).catch(() => {
    alert('Erro ao copiar. Selecione manualmente o c√≥digo.');
  });
}

// Gerar payload PIX
function gerarPayload(chave, nome, cidade, valor) {
  function tamanho(str) {
    return (str.length < 10 ? "0" : "") + str.length;
  }

  const brcode = 
    "000201" +
    "26" + tamanho("0014BR.GOV.BCB.PIX01" + tamanho(chave) + chave) +
    "0014BR.GOV.BCB.PIX01" + tamanho(chave) + chave +
    "52040000" +
    "5303986" +
    "54" + tamanho(valor) + valor +
    "5802BR" +
    "59" + tamanho(nome) + nome +
    "60" + tamanho(cidade) + cidade +
    "62070503***" +
    "6304";

  // Calcula CRC16
  const crc = gerarCRC16(brcode);
  return brcode + crc;
}

// Calcular CRC16
function gerarCRC16(str) {
  const polinomio = 0x1021;
  let resultado = 0xFFFF;
  for (let i = 0; i < str.length; i++) {
    resultado ^= str.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      if (resultado & 0x8000) {
        resultado = (resultado << 1) ^ polinomio;
      } else {
        resultado <<= 1;
      }
      resultado &= 0xFFFF;
    }
  }
  return resultado.toString(16).toUpperCase().padStart(4, "0");
}

// Salvar compras (Firebase ou localStorage)
function salvarCompras() {
  if (db) {
    db.ref('compras').set(compras);
  } else {
    localStorage.setItem('compras', JSON.stringify(compras));
  }
}

// Carregar compras (Firebase ou localStorage)
async function carregarCompras() {
  if (db) {
    const snapshot = await db.ref('compras').once('value');
    compras = snapshot.val() || [];
  } else {
    compras = JSON.parse(localStorage.getItem('compras')) || [];
  }
  renderHistoricoCompras();
}

// Adicionar registro de compra de forma at√¥mica
function adicionarCompraRegistro(nova) {
  if (db) {
    firebase.database().ref('compras').transaction(curr => {
      const listaAtual = Array.isArray(curr) ? curr : [];
      return [nova, ...listaAtual];
    }).then(() => {
      carregarCompras();
    }).catch(() => {
      db.ref('compras').once('value').then(snap => {
        const lista = Array.isArray(snap.val()) ? snap.val() : [];
        const novaLista = [nova, ...lista];
        return db.ref('compras').set(novaLista);
      }).then(() => carregarCompras());
    });
  } else {
    const lista = JSON.parse(localStorage.getItem('compras')) || [];
    const novaLista = [nova, ...lista];
    localStorage.setItem('compras', JSON.stringify(novaLista));
    compras = novaLista;
  }
}

// Renderiza hist√≥rico de compras no admin
function renderHistoricoCompras() {
  const list = document.getElementById('historicoList');
  if (!list) return;
  list.innerHTML = '';
  if (compras.length === 0) {
    list.innerHTML = '<p style="text-align:center; padding:10px;">Nenhuma compra registrada ainda.</p>';
    return;
  }
  compras.forEach(c => {
    const dataCompra = new Date(c.criadoEm);
    const horaMinuto = dataCompra.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const dataFormatada = dataCompra.toLocaleDateString('pt-BR');

    const div = document.createElement('div');
    div.className = 'produto';
    div.style.cssText = 'flex-direction: column; align-items: stretch; margin-bottom: 10px; padding: 10px 20px;';

    const itensHtml = c.itens.map(it => `
      <div class="cart-item" style="padding: 5px 0; background: transparent;">
        <span>${it.nome} <span class="badge">x${it.quantidade}</span></span>
        <span>R$ ${(it.preco * it.quantidade).toFixed(2)}</span>
      </div>
    `).join('');

    div.innerHTML = `
      <div onclick="toggleHistoricoDetalhes(${c.id})" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; width: 100%;">
        <div>
          <span style="font-weight: bold; font-size: 1.1em;">${horaMinuto}</span>
          <span style="color: #666; margin-left: 10px;">${dataFormatada}</span>
        </div>
        <div style="font-weight: bold; font-size: 1.2em; color: #28a745;">
          R$ ${c.total.toFixed(2)}
        </div>
      </div>
      <div id="historico-detalhes-${c.id}" style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
        <h4 style="margin-bottom: 10px;">Itens da Compra:</h4>
        ${itensHtml}
        <div style="margin-top: 15px; text-align: right;">
          <button class="btn btn-secondary" onclick="copiarPixRegistro(${c.id})">üìã Copiar C√≥digo PIX</button>
        </div>
      </div>
    `;
    list.appendChild(div);
  });
}

function toggleHistoricoDetalhes(id) {
  const detalhes = document.getElementById(`historico-detalhes-${id}`);
  if (detalhes) {
    detalhes.style.display = detalhes.style.display === 'none' ? 'block' : 'none';
  }
}

function copiarPixRegistro(id) {
  const reg = compras.find(x => x.id === id);
  if (!reg) return;
  const txt = reg.payloadPix || '';
  navigator.clipboard.writeText(txt).then(() => {
    alert('Payload PIX copiado!');
  }).catch(() => {
    alert('Erro ao copiar.');
  });
}

// Inicializar
carregarEstoque();
carregarSugestoes();
carregarCompras();
try { isAdminLogged = localStorage.getItem('isAdminLogged') === '1'; } catch(e) { isAdminLogged = false; }
</script>

</body>
</html>
